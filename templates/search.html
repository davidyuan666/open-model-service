<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLIP Image-Text and Image-Image Similarity</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-md overflow-hidden">
        <div class="p-8">
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="text-input">
                    Enter Text:
                </label>
                <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="text-input" type="text" placeholder="Enter text here">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="image-input">
                    Upload Image:
                </label>
                <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="image-input" type="file" accept="image/*">
            </div>
            <div class="flex items-center justify-between mb-4">
                <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" id="upload-btn">
                    Upload Image
                </button>
                <button class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" id="compare-btn">
                    Compare Selected Images
                </button>
            </div>
            <div id="result" class="mt-4 text-gray-700"></div>
            <div class="mt-8">
                <h2 class="text-xl font-bold mb-4">Uploaded Images</h2>
                <div class="overflow-x-auto">
                    <div class="inline-block min-w-full shadow rounded-lg overflow-hidden">
                        <table class="min-w-full leading-normal">
                            <thead>
                                <tr>
                                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                        Select
                                    </th>
                                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                        Image Name
                                    </th>
                                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                        Image URL
                                    </th>
                                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                        Preview
                                    </th>
                                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                        Action
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="image-list">
                                <!-- Image list will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>



        $(document).ready(function() {
            let uploadedImages = [];

            $(document).on('click', '.delete-btn', function() {
                const imageName = $(this).data('name');
                if (confirm(`Are you sure you want to delete ${imageName}?`)) {
                    $.ajax({
                        url: '/image/delete_image',
                        type: 'POST',
                        data: JSON.stringify({ image_name: imageName }),
                        contentType: 'application/json',
                        dataType: 'json',
                        success: function(response) {
                            $('#result').html(response.message);
                            loadUploadedImages();  // 刷新图片列表
                        },
                        error: function(error) {
                            $('#result').html('Error: ' + (error.responseJSON ? error.responseJSON.error : error));
                        }
                    });
                }
            });
            
            function loadUploadedImages() {
                $.ajax({
                    url: '/image/list_uploaded_images',
                    type: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        uploadedImages = response;
                        updateImageList();
                    },
                    error: function(error) {
                        console.error('Error loading uploaded images:', error);
                    }
                });
            }


            function uploadImage(imageFile) {
                return new Promise((resolve, reject) => {
                    var formData = new FormData();
                    formData.append('image', imageFile);

                    $.ajax({
                        url: '/image/upload_image',
                        type: 'POST',
                        data: formData,
                        contentType: false,
                        processData: false,
                        success: resolve,
                        error: reject
                    });
                });
            }

            function updateImageList() {
                let tableBody = $('#image-list');
                tableBody.empty();
                uploadedImages.forEach((image, index) => {
                    tableBody.append(`
                        <tr>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                                <input type="checkbox" class="image-select" data-index="${index}">
                            </td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                                <p class="text-gray-900 whitespace-no-wrap">${image.name}</p>
                            </td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                                <a href="${image.url}" target="_blank" class="text-blue-500 hover:underline whitespace-no-wrap">${image.url}</a>
                            </td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                                <img src="${image.url}" alt="${image.name}" class="w-16 h-16 object-cover">
                            </td>
                            <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                                <button class="delete-btn bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded" data-name="${image.name}">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    `);
                });
            }

            $('#upload-btn').click(function() {
                var imageFile = $('#image-input')[0].files[0];
                
                if (!imageFile) {
                    alert('Please select an image to upload.');
                    return;
                }

                uploadImage(imageFile)
                    .then(response => {
                        loadUploadedImages();  // 刷新图片列表
                        $('#result').html('Image uploaded successfully: ' + response.image_url);
                    })
                    .catch(error => {
                        $('#result').html('Error: ' + (error.responseJSON ? error.responseJSON.error : error));
                    });
            });



            $('#compare-btn').click(function() {
                let selectedImages = $('.image-select:checked').map(function() {
                    return uploadedImages[$(this).data('index')];
                }).get();

                if (selectedImages.length !== 2) {
                    alert('Please select exactly two images to compare.');
                    return;
                }

                let data = {
                    image1: selectedImages[0].url,
                    image2: selectedImages[1].url,
                    language: 'chn'
                };

                $.ajax({
                    url: '/image/clip/compare_images',
                    type: 'POST',
                    data: JSON.stringify(data),
                    contentType: 'application/json',
                    dataType: 'json'
                })
                .then(response => {
                    $('#result').html('Image-Image Similarity Score: ' + response.similarity_score.toFixed(4));
                })
                .catch(error => {
                    $('#result').html('Error: ' + (error.responseJSON ? error.responseJSON.error : error));
                });
            });

            // 页面加载时获取已上传的图片列表
            loadUploadedImages();


        });
    </script>
</body>
</html>