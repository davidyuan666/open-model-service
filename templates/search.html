{% extends "base.html" %}

{% block title %}CLIP Image Search{% endblock %}

{% block content %}
    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-md overflow-hidden">
        <div class="p-8">
            <h1 class="text-2xl font-bold mb-6">CLIP Image Search</h1>
            
            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-2">Upload Image</h2>
                <input type="file" id="image-upload" accept="image/*" class="mb-2">
                <button id="upload-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Upload
                </button>
            </div>

            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-2">Find Similar Images</h2>
                <select id="input-image" class="mb-2 p-2 border rounded"></select>
                <input type="number" id="image-threshold" value="0.5" min="0" max="1" step="0.1" class="mb-2 p-2 border rounded">
                <button id="find-similar-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                    Find Similar
                </button>
            </div>

            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-2">Find Images by Text</h2>
                <input type="text" id="input-text" placeholder="Enter text" class="mb-2 p-2 border rounded w-full">
                <input type="number" id="text-threshold" value="0.5" min="0" max="1" step="0.1" class="mb-2 p-2 border rounded">
                <button id="find-by-text-btn" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">
                    Find by Text
                </button>
            </div>

            <div id="result" class="mt-6"></div>
        </div>
    </div>
    {% endblock %}

    {% block scripts %}
    <script>
        $(document).ready(function() {
            function loadUploadedImages() {
                $.ajax({
                    url: '/image/list_uploaded_images',
                    type: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        let select = $('#input-image');
                        select.empty();
                        response.forEach(function(image) {
                            select.append($('<option></option>').attr('value', image.url).text(image.name));
                        });
                    },
                    error: function(error) {
                        console.error('Error loading uploaded images:', error);
                    }
                });
            }

            loadUploadedImages();

            $('#upload-btn').click(function() {
                let fileInput = $('#image-upload')[0];
                if (fileInput.files.length === 0) {
                    alert('Please select an image to upload.');
                    return;
                }

                let formData = new FormData();
                formData.append('image', fileInput.files[0]);

                $.ajax({
                    url: '/image/upload_image',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        alert('Image uploaded successfully');
                        loadUploadedImages();
                    },
                    error: function(error) {
                        alert('Error uploading image: ' + error.responseJSON.error);
                    }
                });
            });

            $('#find-similar-btn').click(function() {
                let inputImage = $('#input-image').val();
                let threshold = $('#image-threshold').val();

                $.ajax({
                    url: '/image/clip/find_similar_images',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        input_image: inputImage,
                        candidate_images: $('#input-image option').map(function() { return $(this).val(); }).get(),
                        threshold: parseFloat(threshold)
                    }),
                    success: function(response) {
                        displayResults(response.similar_images);
                    },
                    error: function(error) {
                        alert('Error finding similar images: ' + error.responseJSON.error);
                    }
                });
            });

            $('#find-by-text-btn').click(function() {
                let inputText = $('#input-text').val();
                let threshold = $('#text-threshold').val();

                $.ajax({
                    url: '/image/clip/find_images_by_text',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        text: inputText,
                        candidate_images: $('#input-image option').map(function() { return $(this).val(); }).get(),
                        threshold: parseFloat(threshold)
                    }),
                    success: function(response) {
                        displayResults(response.similar_images);
                    },
                    error: function(error) {
                        alert('Error finding images by text: ' + error.responseJSON.error);
                    }
                });
            });

            function displayResults(results) {
                let resultDiv = $('#result');
                resultDiv.empty();
                if (results.length === 0) {
                    resultDiv.append('<p>No similar images found.</p>');
                } else {
                    let resultHtml = '<div class="grid grid-cols-2 gap-4">';
                    results.forEach(function(item) {
                        resultHtml += `
                            <div class="border p-4 rounded">
                                <img src="${item.image}" alt="Similar image" class="w-full h-40 object-cover mb-2">
                                <p>Similarity: ${item.similarity.toFixed(4)}</p>
                            </div>
                        `;
                    });
                    resultHtml += '</div>';
                    resultDiv.append(resultHtml);
                }
            }
        });
    </script>
{% endblock %}